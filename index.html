<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self'; base-uri 'self'; form-action 'self'">
  <title>dream - متجر عصري</title>
  <meta name="description" content="متجر dream: منتجات رقمية وتنزيلات فورية + منتجات ملموسة مع توصيل سريع. تصميم أبيض نظيف وأزرار سوداء.">

  <style>
    :root{
      --bg:#ffffff; --txt:#111111; --muted:#666666;
      --card:#ffffff; --border:rgba(0,0,0,.14); --shadow:0 8px 30px rgba(0,0,0,.06);
      --btn:#000000; --btnTxt:#ffffff; --chip:#f2f2f2;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",sans-serif}
    a{color:#000}
    .container{max-width:1200px;margin:auto;padding:20px}

    /* HERO (صورتان) */
    .hero{padding:30px 20px 10px}
    .gallery{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .img-card{
      position:relative;overflow:hidden;border-radius:22px;border:1px solid var(--border);
      background:#fff;cursor:pointer;box-shadow:var(--shadow);min-height:320px
    }
    .img-card picture,.img-card img{display:block;width:100%;height:100%}
    .img-card img{object-fit:cover;aspect-ratio:16/10}
    .img-card::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.0),rgba(0,0,0,.18));pointer-events:none}
    .img-caption{position:absolute;inset:auto 12px 12px 12px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .img-caption .title{font-weight:900;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.35)}
    .img-caption .go{border:none;background:#000;color:#fff;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}

    /* أقسام */
    section{scroll-margin-top:80px}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin:30px 0 10px}
    .filters{display:flex;gap:8px}
    .chip{
      border:1px solid var(--border); background:var(--chip); color:#111; padding:8px 12px;
      border-radius:999px; cursor:pointer; font-weight:700
    }
    .chip.active{background:#000;color:#fff;border-color:#000}

    /* شبكة المنتجات */
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden;display:flex;flex-direction:column;transition:transform .15s, box-shadow .15s}
    .card:hover{transform:translateY(-4px);box-shadow:var(--shadow)}
    .thumb{aspect-ratio:16/10;background:#fafafa;display:flex;align-items:center;justify-content:center;font-size:40px}
    .content{padding:14px}
    .title{font-weight:800;margin:0 0 6px}
    .muted{color:var(--muted);font-size:13px}
    .priceRow{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
    .badge{border:1px dashed var(--border);padding:4px 8px;border-radius:999px;font-size:12px;color:#444}
    .add{margin-top:12px; display:flex; gap:8px}
    .btn{width:100%;border:none;background:var(--btn);color:var(--btnTxt);padding:10px 12px;border-radius:10px;font-weight:800;cursor:pointer}
    .btn.outline{background:#fff;color:#000;border:1px solid #000}

    /* السلة (مودال) */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:60}
    .overlay.show{display:flex}
    .cart{width:min(560px,92vw);background:#fff;border:1px solid var(--border);border-radius:20px;padding:16px;box-shadow:var(--shadow);color:#111}
    .cart h3{margin:0 0 10px}
    .cart .row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 0;border-bottom:1px solid rgba(0,0,0,.08)}
    .cart .row:last-child{border-bottom:none}
    .qty{display:flex;gap:8px;align-items:center}
    .qty button{border:1px solid rgba(0,0,0,.25);background:#fff;color:#111;padding:4px 8px;border-radius:8px;cursor:pointer}
    .checkout{margin-top:12px;display:flex;gap:8px;justify-content:flex-end}
    .checkout .btn{min-width:140px}

    @media (max-width:1100px){ .grid{grid-template-columns:repeat(3,1fr)} .gallery{grid-template-columns:1fr} }
    @media (max-width:700px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:480px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <!-- حقن الهيدر -->
  <div id="app-header" aria-hidden="true"></div>

  <main>
    <!-- الهيرو: صورتان فقط -->
    <section class="hero container">
      <div class="gallery">
        <!-- رقمية -->
        <figure class="img-card" data-filter="digital" aria-label="منتجات رقمية">
          <picture>
            <img src="image/digital.png" alt="منتجات رقمية" loading="eager" decoding="async">
          </picture>
          <figcaption class="img-caption">
            <span class="title">منتجات رقمية</span>
            <button class="go" type="button">استعراض</button>
          </figcaption>
        </figure>
        <!-- ملموسة -->
        <figure class="img-card" data-filter="physical" aria-label="منتجات ملموسة">
          <picture>
            <img src="image/physical.jpg" alt="منتجات ملموسة" loading="eager" decoding="async">
          </picture>
          <figcaption class="img-caption">
            <span class="title">منتجات ملموسة</span>
            <button class="go" type="button">استعراض</button>
          </figcaption>
        </figure>
      </div>
    </section>

    <!-- المنتجات -->
    <section id="products" class="container">
      <div class="section-title">
        <h2>المنتجات</h2>
        <div class="filters" role="tablist" aria-label="فلاتر">
          <button class="chip active" data-filter="all" role="tab">الكل</button>
          <button class="chip" data-filter="digital" role="tab">رقمية</button>
          <button class="chip" data-filter="physical" role="tab">ملموسة</button>
        </div>
      </div>
      <div id="grid" class="grid" aria-live="polite"></div>
    </section>
  </main>

  <!-- حقن الفوتر -->
  <div id="app-footer" aria-hidden="true"></div>

  <!-- مودال السلة -->
  <div id="cartOverlay" class="overlay" aria-hidden="true">
    <div class="cart" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
      <h3 id="cartTitle">سلة المشتريات</h3>
      <div id="cartRows"></div>
      <div class="checkout">
        <button class="btn outline" id="closeCart">إغلاق</button>
        <button class="btn" id="checkoutBtn">إتمام الشراء</button>
      </div>
    </div>
  </div>

  <script type="module">
    // تضمين الهيدر والفوتر
    async function include(id, file){
      const el = document.getElementById(id);
      try{
        const res = await fetch(file, {cache:"no-store"});
        if(!res.ok) throw new Error(res.statusText);
        const html = await res.text();
        el.innerHTML = html;
        // تفعيل سكربتات الجزء
        el.querySelectorAll('script').forEach(old=>{
          const s=document.createElement('script'); if(old.type) s.type=old.type;
          s.textContent=old.textContent; el.appendChild(s); old.remove();
        });
        el.setAttribute('aria-hidden','false');
      }catch(e){
        el.innerHTML = '<div class="container" style="color:#c00">تعذّر تحميل '+file+'</div>';
      }
    }
    await include('app-header','header.html');
    await include('app-footer','footer.html');

    // بيانات المنتجات
    const products = [
      {id:'d1', type:'digital', title:'قالب UI أبيض/أسود', desc:'Figma + SVG', price:69, icon:'⬛', stock:Infinity},
      {id:'d2', type:'digital', title:'بايثون باك: أدوات تحليل', desc:'CLI + Docs', price:119, icon:'⬜', stock:Infinity},
      {id:'d3', type:'digital', title:'مؤثرات صوتية Minimal', desc:'WAV/MP3', price:39, icon:'◻️', stock:Infinity},
      {id:'d4', type:'digital', title:'خط عربي حديث', desc:'OTF/TTF', price:49, icon:'◼️', stock:Infinity},
      {id:'p1', type:'physical', title:'دفتر ملاحظات أسود', desc:'ورق عالي الجودة', price:59, icon:'📓', stock:20},
      {id:'p2', type:'physical', title:'كوب سيراميك أبيض', desc:'مقاوم للحرارة', price:45, icon:'☕', stock:35},
      {id:'p3', type:'physical', title:'تيشيرت dream', desc:'قطن 100%', price:99, icon:'👕', stock:18},
      {id:'p4', type:'physical', title:'ملصقات Minimal', desc:'مجموعة 10 قطع', price:25, icon:'🏷️', stock:50},
    ];

    const grid = document.getElementById('grid');
    const chips = document.querySelectorAll('.chip');

    const CART_KEY = 'dream.cart.v1';
    const cart = new Map(JSON.parse(localStorage.getItem(CART_KEY) || '[]'));
    const money = v => new Intl.NumberFormat('ar-SA',{style:'currency',currency:'SAR'}).format(v);
    const persistCart = () => localStorage.setItem(CART_KEY, JSON.stringify([...cart.entries()]));

    function waLink(title){
      const body = `مرحباً، أود الاستعلام عن المنتج: ${title}`;
      return 'https://wa.me/966504317267?text=' + encodeURIComponent(body);
    }

    function render(filter='all', search=''){
      const q = (search||'').trim().toLowerCase();
      grid.innerHTML='';
      const list = products.filter(p => (filter==='all' || p.type===filter))
                           .filter(p => !q || p.title.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q));
      for(const p of list){
        const el = document.createElement('article');
        el.className='card';
        el.innerHTML = `
          <div class="thumb" aria-hidden="true">${p.icon}</div>
          <div class="content">
            <h3 class="title">${p.title}</h3>
            <div class="muted">${p.desc}</div>
            <div class="priceRow">
              <span>${money(p.price)}</span>
              <span class="badge">${p.type==='digital'?'رقمي':'ملموس'}</span>
            </div>
            <div class="add">
              <button class="btn" data-id="${p.id}" ${p.stock===0?'disabled':''}>${p.stock===0?'غير متوفر':'أضف للسلة'}</button>
              <a class="btn outline wh-btn" href="${waLink(p.title)}" target="_blank" rel="noopener" title="الاستعلام عبر واتساب">واتساب</a>
            </div>
          </div>`;
        grid.appendChild(el);
      }
    }
    render();

    // فلاتر الأزرار
    let currentFilter='all', currentSearch='';
    chips.forEach(ch=> ch.addEventListener('click', ()=>{
      chips.forEach(x=>x.classList.remove('active'));
      ch.classList.add('active'); currentFilter = ch.dataset.filter; render(currentFilter, currentSearch);
    }));

    // بطاقات الهيرو تختار الفلتر
    document.querySelectorAll('.img-card').forEach(card=>{
      card.addEventListener('click', ()=>{
        const f = card.dataset.filter || 'all';
        chips.forEach(x=>x.classList.toggle('active', x.dataset.filter===f));
        currentFilter = f; currentSearch='';
        render(currentFilter, currentSearch);
        document.getElementById('products').scrollIntoView({behavior:'smooth', block:'start'});
      });
    });

    // بحث من الهيدر
    window.addEventListener('dream:search', (e)=>{
      currentSearch = (e.detail?.value || '').toString();
      render(currentFilter, currentSearch);
      grid.scrollIntoView({behavior:'smooth', block:'start'});
    });

    // السلة
    const overlay = document.getElementById('cartOverlay');
    const rows = document.getElementById('cartRows');
    const closeCartBtn = document.getElementById('closeCart');
    const checkoutBtn = document.getElementById('checkoutBtn');

    grid.addEventListener('click', e=>{
      const btn = e.target.closest('button[data-id]'); if(!btn) return;
      const id = btn.getAttribute('data-id'); const item = products.find(p=>p.id===id); if(!item) return;
      if(item.type==='physical' && (cart.get(id)||0) >= item.stock){ alert('تجاوزت المتاح في المخزون لهذا المنتج.'); return; }
      cart.set(id, (cart.get(id)||0)+1); persistCart(); openCart();
    });

    function openCart(){ drawCart(); overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); }
    function closeCart(){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); }
    closeCartBtn.addEventListener('click', closeCart);
    overlay.addEventListener('click', e=>{ if(e.target===overlay) closeCart(); });
    window.addEventListener('dream:openCart', openCart);

    function drawCart(){
      rows.innerHTML=''; let total=0;
      for(const [id, qty] of cart.entries()){
        const p = products.find(x=>x.id===id); if(!p) continue;
        total += p.price*qty;
        const row = document.createElement('div');
        row.className='row';
        row.innerHTML = `
          <div>
            <div><strong>${p.title}</strong> <span class="badge">${p.type==='digital'?'رقمي':'ملموس'}</span></div>
            <div class="muted">${money(p.price)} × ${qty}</div>
          </div>
          <div class="qty">
            <button data-op="dec" data-id="${id}" aria-label="نقص">−</button>
            <span>${qty}</span>
            <button data-op="inc" data-id="${id}" aria-label="زيادة">+</button>
            <button data-op="del" data-id="${id}" aria-label="حذف">🗑️</button>
          </div>`;
        rows.appendChild(row);
      }
      const tot = document.createElement('div');
      tot.className='row'; tot.innerHTML = `<div><strong>الإجمالي</strong></div><div><strong>${money(total)}</strong></div>`;
      rows.appendChild(tot);
    }

    rows.addEventListener('click', e=>{
      const btn = e.target.closest('button[data-op]'); if(!btn) return;
      const id = btn.getAttribute('data-id'); const op = btn.getAttribute('data-op');
      const item = products.find(p=>p.id===id); if(!item) return;
      if(op==='inc'){
        if(item.type==='physical' && (cart.get(id)||0) >= item.stock){ alert('لا يوجد مخزون إضافي.'); return; }
        cart.set(id,(cart.get(id)||0)+1);
      }else if(op==='dec'){
        const n=(cart.get(id)||0)-1; if(n<=0) cart.delete(id); else cart.set(id,n);
      }else if(op==='del'){ cart.delete(id); }
      persistCart(); drawCart();
    });

    checkoutBtn.addEventListener('click', ()=>{
      if(cart.size===0){ alert('السلة فارغة.'); return; }
      alert('شكرًا لك! تم تسجيل طلبك مبدئيًا (نموذج).');
      cart.clear(); persistCart(); drawCart(); closeCart();
    });
  </script>
</body>
</html>
